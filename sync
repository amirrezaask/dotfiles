#!/usr/bin/env bash

set -e


install-neovim() {
	NEOVIM_DIR="$HOME/.local/neovim"
	if [ -z "$NEOVIM_RELEASE" ]; then
		NEOVIM_RELEASE="master"
	fi

	echo "Syncing neovim@$NEOVIM_RELEASE"

	if [ ! -d $NEOVIM_DIR ]; then
		git clone --depth 1 https://github.com/neovim/neovim.git $NEOVIM_DIR
	fi

	cd $NEOVIM_DIR

	git pull
	git checkout "$NEOVIM_RELEASE"

	sudo make distclean || true
	sudo make clean || true
	make CMAKE_BUILD_TYPE=Release
	sudo make install
}

# Detect OS / distro
detect_os() {
    # macOS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
        return
    fi

    # Linux: use /etc/os-release for distro detection
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release

        case "$ID" in
            ubuntu)
                echo "ubuntu"
                ;;
            debian)
                echo "debian"
                ;;
            fedora)
                echo "fedora"
                ;;
            rhel|centos)
                echo "rhel"
                ;;
            arch)
                echo "arch"
                ;;
            *)
                echo "$ID"
                ;;
        esac
        return
    fi

    # Fallbacks
    echo "unknown"
}

OS=$(detect_os)

echo "Detected OS: $OS"


DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_PACKAGES=false

# Parse args
for arg in "$@"; do
    case "$arg" in
        --with-platform)
            INSTALL_PLATFORM=true
            ;;
    esac
done

# Resolve base OS dependency
if [ "$INSTALL_PLATFORM" = true ]; then
	if [[ -z "${OS:-}" ]]; then
		echo "Error: OS variable is not set."
		exit 1
	fi

	# Install Rust & Cargo
	if ! command -v cargo >/dev/null 2>&1; then
		curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
	fi

	if [[ -f "$HOME/.cargo/env" ]]; then
		source "$HOME/.cargo/env"
	fi


	# exa (better ls)
	if ! command -v eza >/dev/null 2>&1; then
		cargo install eza
	fi
	# Install base OS packages
	case "$OS" in
		"ubuntu")
			sudo add-apt-repository -y ppa:cppiber/hyprland
			sudo add-apt-repository -y ppa:longsleep/golang-backports
			sudo apt update && sudo apt upgrade -y

			sudo apt install -y \
				git \
				curl \
				wget \
				btop \
				hyprland \
				hypridle \
				swaylock \
				pulsemixer \
				mako-notifier \
				fish \
				alacritty \
				swaybg \
				waybar \
				wl-clipboard \
				wofi \
				swayosd \
				polkit-gnome \
				chromium \
				golang-go \
				mpv \
				fzf

			# bluetui
			if ! command -v bluetui >/dev/null 2>&1; then
				cargo install bluetui
			fi

			# Systemd login configuration
			sudo tee /etc/systemd/logind.conf >/dev/null <<'EOF'
[Login]
HandlePowerKey=poweroff
HandleSuspendKey=ignore
HandleHibernateKey=ignore
HandleLidSwitch=suspend
HandleLidSwitchExternalPower=suspend
HandleLidSwitchDocked=suspend
KillUserProcesses=no
IdleAction=ignore
EOF

			# Lock screen before suspend
			sudo tee /etc/systemd/system/lock-before-suspend.service >/dev/null <<'EOF'
[Unit]
Description=Lock screen before suspend
Before=sleep.target

[Service]
Type=oneshot
ExecStart=swaylock
RemainAfterExit=yes

[Install]
WantedBy=sleep.target
EOF

			sudo systemctl daemon-reload
			sudo systemctl enable lock-before-suspend.service
			;;
		"fedora")
			sudo dnf -y copr enable solopasha/hyprland
			sudo dnf -y copr enable markupstart/SwayOSD
			sudo dnf -y copr enable dejan/lazygit
			sudo dnf -y copr enable azandure/clipse

			sudo dnf -y install \
				https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-42.noarch.rpm \
				https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-42.noarch.rpm

			sudo dnf groupupdate multimedia --setop="install_weak_deps=False" \
				  --exclude=PackageKit-gstreamer-plugin

			sudo dnf -y install gstreamer1-libav \
				gstreamer1-plugins-{base,good,bad-free,bad-free-extras,ugly} \
				ffmpeg

			sudo dnf -y install \
				git \
				curl \
				wget \
				btop \
				hyprland \
				hypridle \
				mako \
				fish \
				alacritty \
				swaybg \
				sway \
				swayidle \
				swaylock \
				waybar \
				wl-clipboard \
				wofi \
				chromium \
				golang-go \
				dbus-devel \
				pavucontrol \
				pkgconf-pkg-config \
				swayosd \
				mpv \
				lazygit \
				clipse \
				ripgrep \
				cmake \
				fzf

			# bluetui
			if ! command -v bluetui >/dev/null 2>&1; then
				cargo install bluetui
			fi
			# Install hyprshot
			if [[ ! -f /usr/bin/hyprshot ]]; then
				sudo curl -L \
					 https://raw.githubusercontent.com/Gustash/Hyprshot/refs/heads/main/hyprshot \
					 -o /usr/bin/hyprshot
				sudo chmod +x /usr/bin/hyprshot
			fi

			# Systemd login configuration
			sudo tee /etc/systemd/logind.conf >/dev/null <<'EOF'
[Login]
HandlePowerKey=poweroff
HandleSuspendKey=ignore
HandleHibernateKey=ignore
HandleLidSwitch=suspend
HandleLidSwitchExternalPower=suspend
HandleLidSwitchDocked=suspend
KillUserProcesses=no
IdleAction=ignore
EOF

			# Lock screen before suspend
			sudo tee /etc/systemd/system/lock-before-suspend.service >/dev/null <<'EOF'
[Unit]
Description=Lock screen before suspend
Before=sleep.target

[Service]
Type=oneshot
ExecStart=swaylock
RemainAfterExit=yes

[Install]
WantedBy=sleep.target
EOF

			sudo systemctl daemon-reload
			sudo systemctl enable lock-before-suspend.service
			;;

		"macos")
			echo "Running provision scripts for macos"
			;;
		*)
			echo "Unsupported distribution: $DISTRO"
			exit 1
			;;
	esac


	install-neovim
fi


# Install configs
CONFIGS_DIR="$DOTFILES_DIR/configs"
XDG_CONFIG="$HOME/.config"

echo "CONFIGS_DIR $CONFIGS_DIR"

rm -rf "$XDG_CONFIG/nvim" \
	"$XDG_CONFIG/ghostty" \
	"$XDG_CONFIG/fish" \
	"$XDG_CONFIG/sway" \
	"$XDG_CONFIG/hypr" \
	"$XDG_CONFIG/waybar" \
	"$XDG_CONFIG/swayosd" \
	"$XDG_CONFIG/swaylock" \
	"$XDG_CONFIG/wofi" \
	"$XDG_CONFIG/alacritty" \
	"$XDG_CONFIG/btop" \
	"$XDG_CONFIG/kitty" \
	"$XDG_CONFIG/starship" \
	"$XDG_CONFIG/Code/User/settings.json" \
	"$XDG_CONFIG/Code/User/keybindings.json" \
	"$XDG_CONFIG/zed/settings.json" \
	"$XDG_CONFIG/zed/keymap.json" \
	"$XDG_CONFIG/bash" \
	"$HOME/.zshrc" \
	"$HOME/.gitconfig" \
	"$HOME/.bashrc" \
	"$HOME/.tmux.conf" \
	"$HOME/.emacs"

mkdir -p "$XDG_CONFIG"
mkdir -p "$XDG_CONFIG/Code/User"

ln -s "$CONFIGS_DIR/nvim" "$XDG_CONFIG/nvim"
ln -s "$CONFIGS_DIR/fish" "$XDG_CONFIG/fish"
ln -s "$CONFIGS_DIR/sway" "$XDG_CONFIG/sway"
ln -s "$CONFIGS_DIR/hypr" "$XDG_CONFIG/hypr"
ln -s "$CONFIGS_DIR/waybar" "$XDG_CONFIG/waybar"
ln -s "$CONFIGS_DIR/swayosd" "$XDG_CONFIG/swayosd"
ln -s "$CONFIGS_DIR/swaylock" "$XDG_CONFIG/swaylock"
ln -s "$CONFIGS_DIR/wofi" "$XDG_CONFIG/wofi"
ln -s "$CONFIGS_DIR/alacritty" "$XDG_CONFIG/alacritty"
ln -s "$CONFIGS_DIR/btop" "$XDG_CONFIG/btop"
ln -s "$CONFIGS_DIR/kitty" "$XDG_CONFIG/kitty"
ln -s "$CONFIGS_DIR/ghostty" "$XDG_CONFIG/ghostty"
ln -s "$CONFIGS_DIR/starship/starship.toml" "$XDG_CONFIG/starship.toml"
ln -s "$CONFIGS_DIR/.gitconfig" "$HOME/.gitconfig"
ln -s "$CONFIGS_DIR/code/settings.json" "$XDG_CONFIG/Code/User/settings.json"
ln -s "$CONFIGS_DIR/code/keybindings.json" "$XDG_CONFIG/Code/User/keybindings.json"
ln -s "$CONFIGS_DIR/zed/settings.json" "$XDG_CONFIG/zed/settings.json"
ln -s "$CONFIGS_DIR/zed/keymap.json" "$XDG_CONFIG/zed/keymap.json"
ln -s "$CONFIGS_DIR/bash" "$XDG_CONFIG/bash"
ln -s "$CONFIGS_DIR/bash/rc" "$HOME/.bashrc"
ln -s "$CONFIGS_DIR/zsh/.zshrc" "$HOME/.zshrc"
ln -s "$CONFIGS_DIR/tmux/tmux.conf" "$HOME/.tmux.conf"
ln -s "$CONFIGS_DIR/emacs/init.el" "$HOME/.emacs"

# Now some mac stuff
if [[ "$(uname)" == "Darwin" ]]; then
  MACOS_CONFIGS_DIR="$HOME/Library/Application Support"
  echo "# macOS configuration Directory: $MACOS_CONFIGS_DIR"

  echo "Linking Sublime $MACOS_CONFIGS_DIR/Sublime Text/Packages/User"
  rm -rf "$MACOS_CONFIGS_DIR/Sublime Text/Packages/User"
  mkdir -p "$MACOS_CONFIGS_DIR/Sublime Text/Packages"
  ln -nsf "$CONFIGS_DIR/sublime" "$MACOS_CONFIGS_DIR/Sublime Text/Packages/User"

  echo "Linking VSCode $MACOS_CONFIGS_DIR/Code/User"
  rm -rf "$MACOS_CONFIGS_DIR/Code/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Code/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$MACOS_CONFIGS_DIR/Code/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$MACOS_CONFIGS_DIR/Code/User/keybindings.json"

  echo "Linking Cursor $MACOS_CONFIGS_DIR/Cursor/User"
  rm -rf "$MACOS_CONFIGS_DIR/Cursor/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Cursor/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$MACOS_CONFIGS_DIR/Cursor/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$MACOS_CONFIGS_DIR/Cursor/User/keybindings.json"

  echo "Linking Antigravity $MACOS_CONFIGS_DIR/Antigravity/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Antigravity/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Antigravity/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$MACOS_CONFIGS_DIR/Antigravity/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$MACOS_CONFIGS_DIR/Antigravity/User/keybindings.json"
fi
