#!/usr/bin/env bash

set -e


install-neovim() {
	NEOVIM_DIR="$HOME/.local/neovim"
	if [ -z "$NEOVIM_RELEASE" ]; then
		NEOVIM_RELEASE="master"
	fi

	echo "Syncing neovim@$NEOVIM_RELEASE"

	if [ ! -d $NEOVIM_DIR ]; then
		git clone --depth 1 https://github.com/neovim/neovim.git $NEOVIM_DIR
	fi

	cd $NEOVIM_DIR

	git pull
	git checkout "$NEOVIM_RELEASE"

	sudo make distclean || true
	sudo make clean || true
	make CMAKE_BUILD_TYPE=Release
	sudo make install
}

# Detect OS / distro
detect_os() {
    # macOS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
		return
    fi

    # Linux: use /etc/os-release for distro detection
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
		echo "$ID"
		return
	fi

	return "unknown"
}

OS=$(detect_os)

echo "Detected OS: $OS"


DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_PACKAGES=false

# Parse args
for arg in "$@"; do
    case "$arg" in
        --with-platform)
            INSTALL_PLATFORM=true
            ;;
    esac
done

# Resolve base OS dependency
if [ "$INSTALL_PLATFORM" = true ]; then
	if [[ -z "${OS:-}" ]]; then
		echo "Error: OS variable is not set."
		exit 1
	fi

	# Install Rust & Cargo
	if ! command -v cargo >/dev/null 2>&1; then
		curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
	fi

	if [[ -f "$HOME/.cargo/env" ]]; then
		source "$HOME/.cargo/env"
	fi

	# eza (better ls)
	if ! command -v eza >/dev/null 2>&1; then
		cargo install eza
	fi

	# starship (prompt)
	if ! command -v starship >/dev/null 2>&1; then
		echo "Installing starship prompt..."
		curl -sS https://starship.rs/install.sh | sh
	fi
fi

# Install configs
CONFIGS_DIR="$DOTFILES_DIR/configs"
XDG_CONFIG="$HOME/.config"

echo "CONFIGS_DIR $CONFIGS_DIR"

rm -rf "$XDG_CONFIG/nvim" \
	"$XDG_CONFIG/ghostty" \
	"$XDG_CONFIG/starship.toml" \
	"$XDG_CONFIG/Code/User/settings.json" \
	"$XDG_CONFIG/Code/User/keybindings.json" \
	"$HOME/.zshrc" \
	"$HOME/.codex" \
	"$XDG_CONFIG/bash" \
	"$HOME/.gitconfig"

mkdir -p "$XDG_CONFIG"
mkdir -p "$XDG_CONFIG/Code/User"

# Linking to $XDG_CONFIG
ln -nsf "$CONFIGS_DIR/nvim" "$XDG_CONFIG/nvim"
ln -nsf "$CONFIGS_DIR/ghostty" "$XDG_CONFIG/ghostty"
ln -nsf "$CONFIGS_DIR/starship/starship.toml" "$XDG_CONFIG/starship.toml"
ln -nsf "$CONFIGS_DIR/.gitconfig" "$HOME/.gitconfig"
ln -nsf "$CONFIGS_DIR/code/settings.json" "$XDG_CONFIG/Code/User/settings.json"
ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$XDG_CONFIG/Code/User/keybindings.json"
ln -nsf "$CONFIGS_DIR/zsh/.zshrc" "$HOME/.zshrc"
ln -nsf "$CONFIGS_DIR/codex" "$HOME/.codex"
ln -nsf "$CONFIGS_DIR/bash/" "$XDG_CONFIG/bash"
ln -nsf "$HOME/.bashrc" "$XDG_CONFIG/bash/bashrc"

# Now some mac stuff
if [[ "$(uname)" == "Darwin" ]]; then
  MACOS_CONFIGS_DIR="$HOME/Library/Application Support"
  echo "macOS configuration Directory: $MACOS_CONFIGS_DIR"

  echo "Linking Sublime $MACOS_CONFIGS_DIR/Sublime Text/Packages/User"
  rm -rf "$MACOS_CONFIGS_DIR/Sublime Text/Packages/User"
  mkdir -p "$MACOS_CONFIGS_DIR/Sublime Text/Packages"
  ln -nsf "$CONFIGS_DIR/sublime" "$MACOS_CONFIGS_DIR/Sublime Text/Packages/User"

  echo "Linking VSCode $MACOS_CONFIGS_DIR/Code/User"
  rm -rf "$MACOS_CONFIGS_DIR/Code/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Code/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$MACOS_CONFIGS_DIR/Code/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$MACOS_CONFIGS_DIR/Code/User/keybindings.json"

  echo "Linking Cursor $MACOS_CONFIGS_DIR/Cursor/User"
  rm -rf "$MACOS_CONFIGS_DIR/Cursor/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Cursor/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$MACOS_CONFIGS_DIR/Cursor/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$MACOS_CONFIGS_DIR/Cursor/User/keybindings.json"

  echo "Linking Antigravity $MACOS_CONFIGS_DIR/Antigravity/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Antigravity/User/settings.json"
  rm -rf "$MACOS_CONFIGS_DIR/Antigravity/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$MACOS_CONFIGS_DIR/Antigravity/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$MACOS_CONFIGS_DIR/Antigravity/User/keybindings.json"
else
  echo "Linking VSCode $XDG_CONFIG/Code/User"
  rm -rf "$XDG_CONFIG/Code/User/settings.json"
  rm -rf "$XDG_CONFIG/Code/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$XDG_CONFIG/Code/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$XDG_CONFIG/Code/User/keybindings.json"

  echo "Linking Cursor $XDG_CONFIG/Cursor/User"
  rm -rf "$XDG_CONFIG/Cursor/User/settings.json"
  rm -rf "$XDG_CONFIG/Cursor/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$XDG_CONFIG/Cursor/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$XDG_CONFIG/Cursor/User/keybindings.json"

  echo "Linking Antigravity $XDG_CONFIG/Antigravity/User/settings.json"
  rm -rf "$XDG_CONFIG/Antigravity/User/settings.json"
  rm -rf "$XDG_CONFIG/Antigravity/User/keybindings.json"
  ln -nsf "$CONFIGS_DIR/code/settings.json" "$XDG_CONFIG/Antigravity/User/settings.json"
  ln -nsf "$CONFIGS_DIR/code/keybindings.json" "$XDG_CONFIG/Antigravity/User/keybindings.json"
fi
