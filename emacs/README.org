* Amirreza Emacs Configuration
** Basic Performance
   for performance improvement stuff look at =early-init.el= file.
** Basic Emacs stuff
   #+BEGIN_SRC elisp
     (setq backup-by-copying t) ;; Always copy files for backup.
     (setq version-control t) ;; Use version numbers for backup.
     (setq delete-old-versions t) ;; Delete old backup of files.
     (setq kept-new-versions 6) ;; Number of newest versions to keep.
     (setq kept-old-versions 2) ;; Number of old versions to keep.
     (setq create-lockfiles nil) ;; Don't create .# files as lock.
     (setq backup-directory-alist ;; all backups should go here (PATTERN . LOCATION)
           '(("." . "~/.emacs.d/backup/")))

     (setq-default indent-tabs-mode nil ;; Don't insert tabs for indentation.
                     tab-width 4) ;; Width of the TAB character in display.


     (defalias 'yes-or-no-p 'y-or-n-p) ;; Show y or n instead of yes or no for question prompts.

     (setq echo-keystrokes 0.1) ;; Show keystrokes in minibuffer faster than default.

     (setq use-dialog-box nil) ;; Don't use any kind of GUI dialog box.

     (setq inhibit-splash-screen 0) ;; Disable Emacs start screen.

     (setq ring-bell-function 'ignore) ;; No bell ringing.

     (set-terminal-coding-system 'utf-8) ;; default emacs encodings
     (set-keyboard-coding-system 'utf-8)
     (prefer-coding-system 'utf-8)

     (setq-default fill-column 80) ;; column number which emacs start to line wrap.

     (setq scroll-step 5) ;; When point moves out of screen, number of lines to scroll
     (setq scroll-margin 5) ;; Scroll margin lines, when point arrives at these margins scroll the display.
     (setq scroll-conservatively 101) ;; Number of lines to scroll to bring point back into view.
     (setq scroll-up-aggressively 0.11) ;; When scrolling how much to move the view.
     (setq scroll-down-aggressively 0.01) ;; Same as above.
     (setq auto-window-vscroll nil) ;; Disable changing window-vscroll automatically.
     (setq fast-but-imprecise-scrolling nil) ;; Disable fast scroll since it does not feel good.
     (setq mouse-wheel-scroll-amount '(5
                                       ((shift) . 10)))
     (setq mouse-wheel-progressive-speed t)

     ;; Horizontal Scroll
     (setq hscroll-step 1) ;; Number of columns to scroll when point is to close to edge.
     (setq hscroll-margin 1) ;; How many columns away from edge to start scrolling.

     (setq custom-file "~/.emacs.d/custom.el") ;; Don't tamper with init.el for custom variables and use given file.

     (use-package delsel ;; delete region when start typing
       :hook (after-init . delete-selection-mode))

     (column-number-mode +1) ;; Show column number in modeline.

     (setq kill-ring-max 15) ;; Capacity of kill-ring.

     (display-battery-mode 1) ;; Show battery in modeline.

     (display-time-mode 1) ;; Show time in modeline.

     (global-display-line-numbers-mode 1) ;; Enable line numbers globally.

     (show-paren-mode 1) ;; Highlight matching parens
     (setq show-paren-delay 0) ;; highlight matching parens instantly.


     (global-set-key (kbd "M-n") (lambda ()
                                   (interactive)
                                   (forward-line 10)))

     (global-set-key (kbd "M-p") (lambda ()
                                   (interactive)
                                   (forward-line -10)))

     (when (> emacs-major-version 26) (global-tab-line-mode -1)) ;; Disable tab line in Emacs 27+.


     (setq-default cursor-type 'bar) ;; Shape of the cursor.

     (blink-cursor-mode 1) ;; Cursor blinks.

     (global-hl-line-mode +1) ;; Highlight current line.
#+END_SRC
** Theme
   #+BEGIN_SRC elisp
     (defvar --current-color 'dark "current state of Emacs colorscheme")
     (defun toggle-color ()
       (interactive)
       (if (eq --current-color 'dark)
           (progn (load-theme 'modus-operandi t) (setq --current-color 'light))
         (progn (load-theme 'modus-vivendi t) (setq --current-color 'dark)))
       )
     (load-theme 'modus-vivendi t)
     (define-key global-map (kbd "<f12>") 'toggle-color)
   #+END_SRC
** Font
   #+BEGIN_SRC elisp
     (defun amirreza/change-font (font)
       (setq default-frame-alist `((font . ,font))))

     (defvar amirreza/font "JetBrainsMono Nerd Font Mono")
     (amirreza/change-font amirreza/font)

     (define-key global-map (kbd "C--") (lambda () (interactive) (text-scale-adjust -1)))
     (define-key global-map (kbd "C-=") (lambda () (interactive) (text-scale-adjust +1)))
   #+END_SRC
** Keybindings
*** Which-key
    Shows possible candidates for continuing a keychord in minibuffer.
   #+begin_src emacs-lisp
     (use-package which-key
       :straight t
       :diminish which-key-mode
       :init
       (setq which-key-sort-order #'which-key-prefix-then-key-order
               which-key-sort-uppercase-first nil
               which-key-add-column-padding 1
               which-key-max-display-columns nil
               which-key-min-display-lines 6
               which-key-side-window-slot -10)
       :config
       (setq which-key-idle-delay 0.3)
       (defalias 'which-key! 'which-key-add-key-based-replacements)
       (which-key-mode 1)
       (which-key-setup-minibuffer))
   #+end_src
*** Keycast
#+begin_src emacs-lisp
(use-package keycast :straight t :bind ("<f10>" . keycast-mode))
#+end_src
** Buffer Management
   #+BEGIN_SRC elisp
     (use-package bufler
       :straight t
       :bind (("C-x C-b" . 'bufler)))
   #+END_SRC
** Window management and Switching
   #+BEGIN_SRC elisp
     (use-package ace-window
       :straight t
       :commands (ace-window)
       :bind (("C-x o" . 'ace-window)
              ("C-x C-o" . 'ace-window)))
   #+END_SRC
** Workspaces
   Using =perspective= you can have groups of windows and buffers associated with a name, this helps you to have just one instance of Emacs and
   work on multiple projects, it's like having multiple workspaces in the desktop environment.
   #+begin_src emacs-lisp
     (use-package perspective
       :straight t
       :bind (("C-x p s" . persp-switch)
              ("C-x p n" . persp-next)
              ("C-x p k" . persp-kill-buffer*))
       :custom
       (persp-initial-frame-name "Main")
       :config
       ;; Running `persp-mode' multiple times resets the perspective list...
       (unless (equal persp-mode t)
         (persp-mode))
       )
   #+end_src 
** Minibuffer Completion
*** Minibuffer and Completions in Tandem  ( By the GREAT Prot )
#+begin_src emacs-lisp
  (use-package mct :straight t
    :config (mct-mode 1)
    :init
    (setq mct-live-update-delay 0.6)
    (setq mct-hide-completion-mode-line t))
#+end_src
*** Embark/Consult
#+begin_src emacs-lisp
    (use-package consult
      :straight t
      :bind (("C-s" . consult-line)
             ("M-s" . consult-ripgrep))
      :config
      (with-eval-after-load 'evil
        (evil-global-set-key 'normal (kbd "??") 'consult-ripgrep)))

    (use-package embark
      :straight t
      :bind
      (("C-." . embark-act)         ;; pick some comfortable binding
       ("C-;" . embark-export)        ;; good alternative: M-.
       ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

      :init
      ;; Optionally replace the key help with a completing-read interface
      (setq prefix-help-command #'embark-prefix-help-command)
      (setq embark-action-indicator
            (lambda (map)
              (which-key--show-keymap "Embark" map nil nil 'no-paging)
              #'which-key--hide-popup-ignore-command)
            embark-become-indicator embark-action-indicator)
      :config
      ;; Hide the mode line of the Embark live/completions buffers
      (add-to-list 'display-buffer-alist
                   '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                     nil
                     (window-parameters (mode-line-format . none)))))

    ;; Consult users will also want the embark-consult package.

    (use-package marginalia
      :straight t
      ;; Either bind `marginalia-cycle` globally or only in the minibuffer
      :bind (("M-A" . marginalia-cycle)
             :map minibuffer-local-map
             ("M-A" . marginalia-cycle))
      :init
      (marginalia-mode))
    (use-package embark-consult
      :straight t
      :after (embark consult)
      :hook
      (embark-collect-mode . consult-preview-at-point-mode))

#+end_src
** Editor
*** Highlight indents
   #+BEGIN_SRC elisp
     (use-package highlight-indent-guides
       :straight t
       :hook ((yaml-mode) . highlight-indent-guides-mode)
       :init
       (setq highlight-indent-guides-method 'character)
       :config
       (add-hook 'focus-in-hook #'highlight-indent-guides-auto-set-faces))
    #+END_SRC
*** Edit files with sudo access
    #+BEGIN_SRC elisp
     (use-package sudo-edit
          :straight t
          :commands (sudo-edit))
    #+END_SRC
*** Expand currently selected region
    #+BEGIN_SRC elisp
     (use-package expand-region
       :straight t
       :bind (("C-=" . 'er/expand-region)
             ("C--" . 'er/contract-region)))
    #+END_SRC
*** Fix indents
    #+begin_src emacs-lisp
      (defun amirreza/fix-indents ()
        (interactive)
        (mark-whole-buffer)
        (indent-region 0 (buffer-size (current-buffer))))
    #+end_src
*** Highlight TODO/FIXME/... items in text
    #+BEGIN_SRC elisp
     (use-package hl-todo
       :straight t
       :hook ((prog-mode) . hl-todo-mode)
       :config
       (setq hl-todo-highlight-punctuation ":"
          hl-todo-keyword-faces
          `(("TODO"       warning bold)
            ("FIXME"      error bold)
            ("HACK"       font-lock-constant-face bold)
            ("REVIEW"     font-lock-keyword-face bold)
            ("NOTE"       success bold)
            ("DEPRECATED" font-lock-doc-face bold))))
    #+END_SRC
*** Handle large files and long lines
    #+BEGIN_SRC elisp
     (use-package so-long 
       :config (global-so-long-mode 1))

     (use-package vlf :straight t :commands (vlf))
    #+END_SRC
*** Edit files over SSH
    #+BEGIN_SRC elisp
     (use-package tramp
           :commands (tramp)
           :config
           (setq tramp-default-method "ssh"))
    #+END_SRC
*** Markdown
    #+BEGIN_SRC elisp
     (use-package markdown-mode
       :straight t
       :mode ("\\.md$" . markdown-mode))
    #+END_SRC
*** Pdf tools
    #+BEGIN_SRC elisp
      (use-package pdf-tools
        :straight t
        :hook (pdf-tools-enabled-hook . menu-bar-mode))
    #+END_SRC
*** Configuration syntax support
    #+BEGIN_SRC elisp
      (use-package crontab-mode :defer t :straight t)

      (use-package apache-mode :straight t
        :mode ("\\.htaccess\\'" "httpd\\.conf\\'" "srm\\.conf\\'" "access\\.conf\\'"))

      (use-package systemd :straight t
        :mode ("\\.service\\'" "\\.timer\\'"))

      (use-package nginx-mode :straight 
        :mode ("/etc/nginx/conf.d/.*" "/etc/nginx/.*\\.conf\\'"))
    #+END_SRC
*** Colorize matching parens
    #+BEGIN_SRC elisp
      (use-package rainbow-delimiters :straight t :defer t)
    #+END_SRC
** IDE
*** Language Server Mode
**** Lsp-Mode
    #+BEGIN_SRC elisp
      (use-package lsp-mode :straight t
        :init
        (setq lsp-file-watch-threshold 10000)
        (setq lsp-auto-guess-root t)
        (setq lsp-keymap-prefix "C-c l")
        (setq lsp-before-save-edit t)
        :bind
        (("M-?" . lsp-find-references))
        :config
        (defun amirreza-lsp-format ()
          (interactive)
          (when (lsp-feature? "textDocument/formatting") (lsp-format-buffer)))

        :hook ((lsp-mode . lsp-enable-which-key-integration)
               (lsp-mode . (lambda () (interactive) (lsp-headerline-breadcrumb-mode -1))) 
               (before-save . amirreza-lsp-format)))

      (use-package lsp-ivy
        :straight t
        :after ivy
        :bind
        (
         ("M-?" . xref-find-references)
         ("M-." . xref-find-definitions)
         ("M-i" . lsp-find-implementation))
        (:map lsp-mode-map
              ("C-S-s" . lsp-ivy-workspace-symbol)))

      (use-package consult-lsp :straight t :after consult)
#+END_SRC
*** Code Completion
   #+BEGIN_SRC elisp
     (use-package company
       :straight t
       :diminish company-mode
       :hook (prog-mode . company-mode)
       :bind (:map company-active-map
                   ("C-n" . company-select-next)
                   ("C-p" . company-select-previous)
                   ("C-o" . company-other-backend)
                   ("<tab>" . company-complete-common-or-cycle)
                   ("RET" . company-complete-selection))
       :config
       (setq company-minimum-prefix-lenght 1)
       (setq company-tooltip-limit 30)
       (setq company-idle-delay 0.0)
       (setq company-echo-delay 0.1)
       (setq company-show-numbers t)
       (setq company-backends '(company-capf company-dabbrev company-files company-dabbrev-code)))

   #+END_SRC
*** Projectile
   #+BEGIN_SRC elisp
     (use-package projectile
       :straight t
       :commands (projectile-find-file projectile-project-root)
       :bind
       (("C-c f" . amirreza/find-file)
        ("C-M-s" . 'amirreza/find-symbol-at-point)
        ("<f1>" . 'amirreza/find-file-at-point)
        ("<f2>" . 'amirreza/find-symbol-at-point)
        ("C-M-f" . 'amirreza/find-file-at-point)
        ("C-M-g" . 'amirreza/find-symbol-at-point))
       :config
       (defun amirreza/find-file ()
         "If we are in project use projectile-find-file else use internal find-file"
         (interactive)
         (cond
          ((projectile-project-p) (projectile-find-file))
          (t (call-interactively 'find-file))))

       (defun amirreza/find-project ()
         "List of projects in pre defined project locations."
         (interactive)
         (dired (completing-read "Project: "
                                 (directory-files-recursively "~/src"
                                                              ".*"
                                                              t
                                                              (lambda (path) (not (projectile-project-p path)))
                                                              t))))

       (defun amirreza/recursive-search-path (initial path)
         (completing-read "Find File: " (directory-files-recursively path directory-files-no-dot-files-regexp nil (lambda (name)
                                                                                                                    (not (string-match "\\.git" name)))
                                                                     t) nil nil initial))

       (defun amirreza/find-symbol-at-point ()
         (interactive)
         (let* ((symbol (thing-at-point 'word)))
           (consult-ripgrep (projectile-project-root) symbol))))


     (use-package project :defer t)
   #+END_SRC
*** Terminal
   #+begin_src elisp
     (use-package vterm :straight t :bind ("C-c t" . vterm-other-window))
   #+end_src
*** Git
    #+begin_src emacs-lisp
      (use-package magit
        :straight t
        :commands (magit-status magit-get-current-branch)
        :init
        (with-eval-after-load 'evil (evil-global-set-key 'normal (kbd "SPC g s") 'magit-status))
        :bind
        (("C-x g" . 'magit-status)))

      (use-package diff-hl
        :straight t
        :config (global-diff-hl-mode 1))

      (use-package git-messenger
        :straight t
        :commands
        (git-messenger:popup-message)
        :init
        (with-eval-after-load 'evil (evil-global-set-key 'normal (kbd "SPC g b") 'git-messenger:popup-message))
        :bind
        (("C-c g b" . git-messenger:popup-message))

        :config
        (setq git-messenger:show-detail t)
        (setq git-messenger:use-magit-popup t))
#+end_src
*** Snippets
    #+begin_src emacs-lisp
      (use-package yasnippet
        :straight t
        :diminish yas-minor-mode
        :config (yas-global-mode 1)
        :bind
        (("C-x C-x" . yas-expand)
         ("C-x C-l" . yas-insert-snippet)))

      (use-package yasnippet-snippets :straight t :after yasnippet)
    #+end_src
*** IMenu: Language agnostic movement in buffer
    #+BEGIN_SRC elisp
      (use-package imenu
        :bind ("M-i" . imenu))
    #+END_SRC
*** Eldoc: Emacs documentation engine
    #+BEGIN_SRC elisp
      (use-package eldoc
        :diminish eldoc-mode
        :config (global-eldoc-mode 1))
    #+END_SRC
** Org
   #+BEGIN_SRC elisp
     (use-package org
           :config
     (defun amirreza/--org-insert-elisp-code-block ()
       (interactive)
       (insert (format "#+begin_src emacs-lisp\n\n#+end_src"))
       (previous-line)
       (beginning-of-line))

     (defun amirreza/--org-insert-no-tangle ()
       ""
       (interactive)
       (insert (format ":PROPERTIES:\n:header-args: :tangle no\n:END:\n"))
       (previous-line)
       (beginning-of-line))

     (setq org-ellipsis "â¤µ")
     (setq org-src-fontify-natively t)
     (setq org-src-tab-acts-natively t)
     (setq org-support-shift-select t)
     (setq org-src-window-setup 'current-window)
     (setq org-startup-folded t)
     :bind (:map org-mode-map
                 ("C-c m n" . amirreza/--org-insert-no-tangle)
                 ("C-c m b" . amirreza/--org-insert-elisp-code-block)))

     (use-package org-bullets
       :straight t
       :hook (org-mode . (lambda () (org-bullets-mode 1))))


     (use-package toc-org :straight t :hook (org-mode . toc-org-mode))

     (use-package htmlize :straight t :defer t)

   #+END_SRC
** Environment Variables
   Since emacs is a GUI app and is not launched by your default shell, probably it's not going to have correct env variables so we need to force all env
   variables from default shell to be in Emacs process as well.
   #+BEGIN_SRC elisp
     (use-package exec-path-from-shell 
       :straight t
       :config
       (setq exec-path-from-shell-shell-name "zsh")
       (exec-path-from-shell-copy-envs '("GOPROXY" "GOPRIVATE"))
       (exec-path-from-shell-initialize))
   #+END_SRC
** Programming Languages
*** Golang
Golang is my main programming language, but after doing a minimalistic life style of Acme for some time
I know tend to use simplest tools and less is more, and also trying to integrate more with command line tools so i have no
fancy feature for Go or any other language, other than the lsp itself.
   #+BEGIN_SRC elisp
     (use-package go-mode
       :straight t
       :mode ("\\.go\\'" . go-mode)
       :hook
       (go-mode . amirreza/go-hook)
       :config
       (defun amirreza/go-ggtags ()
         (interactive)
         (shell-command-to-string (format"gogtags -p %s" (amirreza/find-root)))
         )
       (defun amirreza/go-hook ()
         (interactive)
         ;; add go binaries to exec-path

         (add-to-list 'exec-path (concat (getenv "HOME") "/go/bin"))
         (lsp)))


     (use-package go-add-tags :straight t :bind (:map go-mode-map ("C-c m s" . go-add-tags)))
     (use-package gotest :straight t 
       :after go-mode
       :config
       (define-key go-mode-map (kbd "C-c m t f") 'go-test-current-file) 
       (define-key go-mode-map (kbd "C-c m t t") 'go-test-current-test))
   #+END_SRC
*** Lisp
   #+BEGIN_SRC elisp
     (use-package paredit :straight t
       :hook ((clojure-mode emacs-lisp-mode) . paredit-mode))

     (use-package parinfer :straight t  :hook ((clojure-mode emacs-lisp-mode) . parinfer-mode))
   #+END_SRC
*** PHP
#+BEGIN_SRC elisp
  (use-package php-mode
    :straight t 
    :mode "\\.php\\'")
#+END_SRC
*** Python
   #+BEGIN_SRC elisp
     (use-package python-mode
       :mode "\\.py\\'")

     (use-package py-autopep8
       :straight t
       :hook python-mode
       :config
       (py-autopep8-enable-on-save))
   #+END_SRC
*** Lua
   #+BEGIN_SRC elisp
     (use-package lua-mode :straight t :mode "\\.lua")
     (setq lsp-clients-lua-language-server-install-dir "/home/amirreza/.local/lua-language-server")
     (setq lsp-clients-lua-language-server-bin (concat lsp-clients-lua-language-server-install-dir "/bin/lua-language-server"))
     (setq lsp-clients-lua-language-server-main-location (concat lsp-clients-lua-language-server-install-dir "/main.lua"))
   #+END_SRC
*** C/C++
   #+begin_src emacs-lisp
(use-package ccls :straight t)
   #+end_src
** DevOps
   #+begin_src emacs-lisp
     (use-package docker-compose-mode
       :straight t
       :mode "docker-compose\\.yml")

     (use-package docker :straight t 
       :bind
       ("C-c i d" . docker))

     (use-package dockerfile-mode :straight t :mode "\\Dockerfile\\'")
     (use-package kubel :straight t :commands (kubel) :bind (("C-c i k" . kubel)))
   #+end_src
** Dotfiles
   #+begin_src emacs-lisp
     (defvar amirreza/dotfiles-location (exec-path-from-shell-copy-env "DOTFILES") "Location of my dotfiles.")

     (defun amirreza/edit-dot-config ()
       (interactive)
       (find-file (completing-read "Edit: " (directory-files-recursively amirreza/dotfiles-location ".*" nil (lambda (name)
                                                                                                               (not (string-match "\\.git" name)))
                                                                         t))))

     (define-key global-map (kbd "C-c e c") 'amirreza/edit-dot-config)
   #+end_src

** Emacs Server
   #+begin_src emacs-lisp
     (server-start)
   #+end_src
