#!/usr/bin/env bash

# set -e

if [[ -z "$1" && "$1" != "CNCLD" ]]; then
  echo "Usage: theme-set <theme-name>" >&2
  exit 1
fi

THEME_NAME=$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

THEMES_DIR="$HOME/.local/themes"

THEME_PATH="$THEMES_DIR/$THEME_NAME"

CURRENT_THEME_DIR="$HOME/.config/current-theme"
CURRENT_BACKGROUND="$HOME/.config/current-background"

ln -nsf $THEME_PATH $CURRENT_THEME_DIR


ln -nsf $CURRENT_THEME_DIR/neovim.lua $HOME/.config/nvim/lua/plugins/theme.lua


touch "$HOME/.config/alacritty/alacritty.toml"

unlink $HOME/.config/btop/themes/current.theme; ln -nsf $CURRENT_THEME_DIR/btop.theme $HOME/.config/btop/themes/current.theme

echo "Links setup done"


if [[ -f ~/.config/current-theme/vscode.theme ]]; then
  . ~/.config/current-theme/vscode.theme
  if [[ -n "$vscode_theme_ext" ]]; then
    code --install-extension "$vscode_theme_ext"
  fi
  sed -i "s/\"workbench.colorTheme\": \".*\"/\"workbench.colorTheme\": \"$vscode_theme_name\"/g" ~/.config/Code/User/settings.json
fi


echo "Colorscheme setup done"


if command -v hyprctl >/dev/null 2>&1; then
	hyprctl reload
fi

if command -v swaymsg >/dev/null 2>&1; then
	swaymsg reload
fi

if pidof waybar >/dev/null 2>&1; then
	restart-app waybar
fi

theme-bg-next

restart-app swaybg -i $CURRENT_BACKGROUND >/dev/null &2>/dev/null &

if [[ -f ~/.config/current-theme/mako.ini ]]; then
	restart-app mako -c $HOME/.config/current-theme/mako.ini
fi

if [[ -f ~/.config/current-theme/light.mode ]]; then
	light-mode
else
	dark-mode
fi

if [[ -f ~/.config/current-theme/neovim.theme ]]; then
	neovim_colorscheme=`cat ~/.config/current-theme/neovim.theme`
	for sock in /tmp/nvimsocket-*; do
		echo "$sock"	
		nvim --server "$sock" --remote-expr "execute('colorscheme $neovim_colorscheme')" >/dev/null 2>&1
	done
fi

notify-send "Theme changed to $THEME_NAME" -t 2000
