#!/usr/bin/env bash

set -e

if [[ -z "$1" && "$1" != "CNCLD" ]]; then
  echo "Usage: theme-set <theme-name>" >&2
  exit 1
fi

THEME_NAME=$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

THEMES_DIR="$HOME/.config/themes"

THEME_PATH="$THEMES_DIR/$THEME_NAME"

CURRENT_THEME_DIR="$HOME/.config/themes/current"
CURRENT_BACKGROUND="$HOME/.config/current-background"

unlink $THEMES_DIR/current
ln -nsf $THEME_PATH $CURRENT_THEME_DIR


touch "$HOME/.config/alacritty/alacritty.toml"

unlink $HOME/.config/nvim/lua/plugins/theme.lua; ln -s $THEMES_DIR/current/neovim.lua ~/.config/nvim/lua/plugins/theme.lua

unlink $HOME/.config/btop/themes/current.theme; ln -nsf $THEMES_DIR/current/btop.theme $HOME/.config/btop/themes/current.theme

echo "Links setup done"


if [[ -f ~/.config/themes/current/vscode.theme ]]; then
  . ~/.config/themes/current/vscode.theme
  if [[ -n "$vscode_theme_ext" ]]; then
    code --install-extension "$vscode_theme_ext"
  fi
  sed -i "s/\"workbench.colorTheme\": \".*\"/\"workbench.colorTheme\": \"$vscode_theme_name\"/g" ~/.config/Code/User/settings.json
fi


echo "Colorscheme setup done"

hyprctl reload

restart-app waybar

theme-bg-next

restart-app swaybg -i $CURRENT_BACKGROUND >/dev/null &2>/dev/null &

if [[ -f ~/.config/themes/current/mako.ini ]]; then
	restart-app mako -c $HOME/.config/themes/current/mako.ini
fi

if [[ -f ~/.config/themes/current/light.mode ]]; then
	light-mode
else
	dark-mode
fi

reload-kitty

notify-send "Theme changed to $THEME_NAME" -t 2000
